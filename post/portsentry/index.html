<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        PortSentry: Detecting and Blocking Port Scans
    </title>
    <link rel="icon" href="/dulkanggg/images/logo.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/dulkanggg/css/style.css">
</head>

<body>
    <div class="container">
        <header>
            <a href="/dulkanggg/" class="logo">
                <img src="/dulkanggg/images/logo.png" alt="Logo"
                    style="height: 40px; vertical-align: middle; margin-right: 10px;">
                Dulkanggg's Corner
            </a>
            <nav>
                <a href="/dulkanggg/">Home</a>
                <a href="/dulkanggg/search.html">Search</a>
                <a href="/dulkanggg/about">About</a>
                <a href="/dulkanggg/rss">RSS</a>
            </nav>
        </header>

    <article class="post-content">
        <h1 style="color: #e2b714;">
            PortSentry: Detecting and Blocking Port Scans
        </h1>
        <div style="color: var(--accent-color); margin-bottom: 20px;">
            <span>
                2025-12-03
            </span>
            
                | Tags:
                
                    <a href="/dulkanggg/tags/ubuntu"
                        style="color: var(--accent-color); text-decoration: underline;">
                        ubuntu
                    </a>
                    
                    <a href="/dulkanggg/tags/vps"
                        style="color: var(--accent-color); text-decoration: underline;">
                        vps
                    </a>
                    
                    <a href="/dulkanggg/tags/security"
                        style="color: var(--accent-color); text-decoration: underline;">
                        security
                    </a>
                    
                    <a href="/dulkanggg/tags/network"
                        style="color: var(--accent-color); text-decoration: underline;">
                        network
                    </a>
                    
                    <a href="/dulkanggg/tags/bilingual"
                        style="color: var(--accent-color); text-decoration: underline;">
                        bilingual
                    </a>
                    
                        
        </div>

        <div>
            <blockquote>
<p><em>üáªüá≥ B·∫£n ti·∫øng Vi·ªát n·∫±m ·ªü ph√≠a d∆∞·ªõi b√†i vi·∫øt (Vietnamese version is available below).</em></p>
</blockquote>
<hr>
<h3>PortSentry: Detecting and Blocking Port Scans</h3>
<p>PortSentry is a classic Intrusion Detection System (IDS) specialized in monitoring and preventing port scanning activities on servers. Although active development has ceased, it remains an excellent lesson in active defense mechanisms for anyone working in system security.</p>
<p>This article will guide you through cross-platform installation and detailed configuration ranging from basic to &quot;paranoid.&quot;</p>
<h3>1. Installing PortSentry on Various Distros</h3>
<p>Depending on your operating system, choose the appropriate installation method:</p>
<p><strong>Debian/Ubuntu/Kali Linux:</strong> Install directly from the official repositories:</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install portsentry
</code></pre>
<p><strong>Fedora/CentOS/RHEL:</strong> Typically, you will need to download the RPM package. Then use the command:</p>
<pre><code class="language-bash">rpm -i portsentry*
</code></pre>
<p>(Note: If the RPM package is not found, you may need to compile from source or search within the EPEL repository).</p>
<p><strong>Arch Linux:</strong> Use the AUR (Arch User Repository). The old command was <code>yaourt</code>, but nowadays you can use <code>yay</code> or <code>paru</code>:</p>
<pre><code class="language-bash">yaourt -S portsentry
# Or
yay -S portsentry
</code></pre>
<h3>2. Configuring Monitoring Tactics</h3>
<p>The main configuration file is located at <code>/etc/portsentry/portsentry.conf</code>. We will open it to edit:</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.conf
</code></pre>
<h4>A. Selecting Port Monitoring Sets (Port Configuration)</h4>
<p>PortSentry provides 3 pre-set monitoring levels. You need to uncomment (#) one of the following sets depending on your security &quot;sensitivity&quot;:</p>
<p><strong>Level 1: &quot;Really Anal&quot; (Paranoid/Strict)</strong>
Select this set if you want to monitor almost all sensitive ports. Anyone touching them will be dealt with. This is the recommended choice.</p>
<pre><code class="language-bash"># Un-comment these if you are really anal:
TCP_PORTS=&quot;1,7,9,11,15,70,79,80,109,110,111,119,138,139,143,512,513,514,515,540,635,1080,1524,2000,2001,4000,4001,5742,6000,6001,6667,12345,12346,20034,30303,32771,32772,32773,32774,31337,40421,40425,49724,54320&quot;
UDP_PORTS=&quot;1,7,9,66,67,68,69,111,137,138,161,162,474,513,517,518,635,640,641,666,700,2049,32770,32771,32772,32773,32774,31337,54321&quot;
</code></pre>
<p><strong>Level 2: &quot;Aware&quot;</strong>
Monitors common ports, balancing security and performance.</p>
<pre><code class="language-bash"># Use these if you just want to be aware:
# TCP_PORTS=&quot;1,11,15,79,111,119,143,540,635,1080,1524,2000,5742,6667,12345,12346,20034,31337,32771,32772,32773,32774,40421,49724,54320&quot;
# UDP_PORTS=&quot;1,7,9,69,161,162,513,635,640,641,700,32770,32771,32772,32773,32774,31337,54321&quot;
</code></pre>
<p><strong>Level 3: &quot;Bare-bones&quot; (Basic)</strong>
Minimal monitoring. Not recommended unless the server is extremely underpowered.</p>
<h4>B. Configuring Stealth Scan</h4>
<p>In addition to the ports above, you can configure monitoring for high port ranges (above 1024) to detect stealth scanning techniques.</p>
<pre><code class="language-bash">ADVANCED_PORTS_TCP=&quot;1023&quot;
ADVANCED_PORTS_UDP=&quot;1023&quot;
</code></pre>
<p>Crucially, make sure to exclude ports that you are actually using (e.g., Web, DNS, NetBIOS ports) to avoid blocking valid users:</p>
<pre><code class="language-bash">ADVANCED_EXCLUDE_TCP=&quot;113,139&quot;
ADVANCED_EXCLUDE_UDP=&quot;520,138,137,67&quot;
</code></pre>
<h3>3. Configuring Response and Blocking</h3>
<p>What should PortSentry do when an attack is detected?</p>
<p><strong>Activate Blocking Mode</strong>
Ensure the following two lines are set to 1 (1 = Block, 0 = Log only, 2 = Run external command):</p>
<pre><code class="language-bash">BLOCK_UDP=&quot;1&quot;
BLOCK_TCP=&quot;1&quot;
</code></pre>
<p><strong>Blocking Method: TCP Wrappers</strong>
A classic but effective blocking method is using <code>hosts.deny</code>. When an attacking IP is detected, PortSentry writes that IP to <code>/etc/hosts.deny</code>, causing services that support TCP Wrappers (like older SSH configs) to reject connections immediately.</p>
<p>Find and uncomment this line:</p>
<pre><code class="language-bash">KILL_HOSTS_DENY=&quot;ALL: $TARGET$ : DENY&quot;
</code></pre>
<p>(Note: <code>$TARGET$</code> is the variable representing the attacker&#39;s IP).</p>
<p><strong>Log Files and History</strong>
Check the log file paths to ensure PortSentry records data in the correct location (Note: paths may vary by distro, e.g., <code>/etc/portsentry/...</code> or <code>/usr/pkg/etc/...</code>):</p>
<pre><code class="language-bash"># Hosts to ignore (Whitelist)
IGNORE_FILE=&quot;/etc/portsentry/portsentry.ignore&quot;
# Hosts that have been denied (Blocking History)
HISTORY_FILE=&quot;/etc/portsentry/portsentry.history&quot;
# Hosts blocked in this session (Current Session)
BLOCKED_FILE=&quot;/etc/portsentry/portsentry.blocked&quot;
</code></pre>
<h3>4. Psychological Tactics: Port Banner</h3>
<p>You can leave a message for the attacker if they intentionally connect to trap ports. This is an interesting feature to serve as a warning.</p>
<pre><code class="language-bash">PORT_BANNER=&quot;** UNAUTHORIZED ACCESS PROHIBITED *** YOUR CONNECTION ATTEMPT HAS BEEN LOGGED. GO AWAY.&quot;
</code></pre>
<h3>5. The Most Important Step: Whitelist (Ignore File)</h3>
<p>Do not lock yourself out! Before starting, you absolutely must add your own IP and the local IP to the ignore list.</p>
<p>Open the <code>portsentry.ignore</code> file (path configured in step 3):</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.ignore
</code></pre>
<p>Add the following:</p>
<pre><code class="language-plaintext">127.0.0.1/32
0.0.0.0
[Your Machine&#39;s IP]
[Gateway IP]
</code></pre>
<h3>6. Start and Verify</h3>
<p>After completion, restart the service:</p>
<pre><code class="language-bash">sudo service portsentry restart
</code></pre>
<p>To verify, use another machine to run a simple nmap scan against the server. Then check the <code>/etc/hosts.deny</code> file on the server; you should see the attacking machine&#39;s IP added to the blacklist along with the warning line.</p>
<h3>Advanced: Sending Email Alerts When Attacks are Detected</h3>
<p>Receiving real-time notifications is a core part of DevSecOps and cybersecurity monitoring.</p>
<p>Below is a detailed guide on how to write a simple Shell script to send emails and integrate it into PortSentry&#39;s <code>KILL_RUN_CMD</code>.</p>
<h4>1. Prepare the Email Environment</h4>
<p>To allow the Linux server to send emails, you need to install the <code>mailutils</code> package (on Debian/Ubuntu) or <code>mailx</code> (on CentOS).</p>
<p><strong>Ubuntu/Debian:</strong></p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install mailutils
</code></pre>
<p>(During installation, if asked to configure Postfix, you can select &quot;Internet Site&quot; if the server has a domain, or &quot;Local only&quot; for internal testing. However, to send to actual Gmail/Outlook, the server needs SMTP Relay configuration, but let&#39;s proceed with creating the script first).</p>
<h4>2. Write the Alert Script (portsentry_alert.sh)</h4>
<p>We will write a script that accepts the Attacker&#39;s IP and the Scanned Port as parameters, then composes and sends an email.</p>
<p>Create the script file:</p>
<pre><code class="language-bash">sudo nano /usr/local/bin/portsentry_alert.sh
</code></pre>
<p>Paste the following content:</p>
<pre><code class="language-bash">#!/bin/bash

# ==========================================
# CONFIGURATION
# ==========================================
TO_EMAIL=&quot;admin@unitrade.id.vn&quot;  # Replace with your email
SUBJECT=&quot;[ALERT] PortSentry Detected Attack!&quot;
SERVER_NAME=$(hostname)
DATE=$(date &quot;+%Y-%m-%d %H:%M:%S&quot;)

# Receive parameters from PortSentry
TARGET_IP=$1
TARGET_PORT=$2

# ==========================================
# EMAIL CONTENT
# ==========================================
BODY=&quot;
Security Alert from Server: $SERVER_NAME
------------------------------------------------
Detection Time      : $DATE
Action Taken        : Blocked
Attacker IP         : $TARGET_IP
Scanned Port        : $TARGET_PORT
------------------------------------------------
System has automatically added a rule to iptables/hosts.deny.
Please check logs at /var/log/syslog for more details.
&quot;

# ==========================================
# SEND MAIL
# ==========================================
echo &quot;$BODY&quot; | mail -s &quot;$SUBJECT&quot; &quot;$TO_EMAIL&quot;
</code></pre>
<p>Grant execution permissions to the script:</p>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/portsentry_alert.sh
</code></pre>
<h4>3. Integrate Script into PortSentry</h4>
<p>Now we go back to the PortSentry configuration file to &quot;teach&quot; it how to call this script when an attack is detected.</p>
<p>Open the config file:</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.conf
</code></pre>
<p>Find the <code>KILL_RUN_CMD</code> line. This line allows running an external command before blocking the IP. Edit it as follows:</p>
<pre><code class="language-bash"># $TARGET$ is the variable containing the IP, $PORT$ is the variable containing the port
KILL_RUN_CMD=&quot;/usr/local/bin/portsentry_alert.sh $TARGET$ $PORT$&quot;
</code></pre>
<p><strong>Important Note:</strong> Ensure <code>BLOCK_UDP</code> and <code>BLOCK_TCP</code> variables are in mode 1 (Block) or 2 (Run Command Only) for the above command to execute. It is best to leave it at 1 to both block and send the email.</p>
<h4>4. Restart and Test</h4>
<p>Restart PortSentry:</p>
<pre><code class="language-bash">sudo service portsentry restart
</code></pre>
<p><strong>Attack Simulation:</strong> Use another machine (or a phone using 4G - to have a different IP than the LAN) to scan:</p>
<pre><code class="language-bash">nmap -p 1-100 &lt;Your_Server_IP&gt;
</code></pre>
<p>If successful, you will receive an email with the content: <code>Subject: [ALERT] PortSentry Detected Attack! Body: Security Alert... Attacker IP: 1.2.3.4.</code></p>
<hr>
<h3>H∆∞·ªõng d·∫´n to√†n t·∫≠p v·ªÅ PortSentry: Ph√°t hi·ªán v√† Ch·∫∑n ƒë·ª©ng Port Scan</h3>
<p>PortSentry l√† m·ªôt c√¥ng c·ª• ph√°t hi·ªán x√¢m nh·∫≠p (IDS) kinh ƒëi·ªÉn, chuy√™n d√πng ƒë·ªÉ gi√°m s√°t v√† ngƒÉn ch·∫∑n c√°c h√†nh vi qu√©t c·ªïng (port scanning) tr√™n m√°y ch·ªß. D√π c√¥ng c·ª• n√†y ƒë√£ ng·ª´ng ph√°t tri·ªÉn, n√≥ v·∫´n l√† m·ªôt b√†i h·ªçc tuy·ªát v·ªùi v·ªÅ c∆° ch·∫ø ph√≤ng th·ªß ch·ªß ƒë·ªông cho b·∫•t k·ª≥ ai l√†m v·ªÅ b·∫£o m·∫≠t h·ªá th·ªëng.</p>
<p>B√†i vi·∫øt n√†y s·∫Ω h∆∞·ªõng d·∫´n b·∫°n c√†i ƒë·∫∑t tr√™n ƒëa n·ªÅn t·∫£ng v√† c·∫•u h√¨nh chi ti·∫øt t·ª´ c∆° b·∫£n ƒë·∫øn &quot;paranoid&quot; (c·ª±c ƒëoan).</p>
<h3>1. C√†i ƒë·∫∑t PortSentry tr√™n c√°c Distro</h3>
<p>T√πy v√†o h·ªá ƒëi·ªÅu h√†nh b·∫°n ƒëang s·ª≠ d·ª•ng, h√£y ch·ªçn ph∆∞∆°ng ph√°p c√†i ƒë·∫∑t ph√π h·ª£p:</p>
<p><strong>Debian/Ubuntu/Kali Linux:</strong> C√†i ƒë·∫∑t tr·ª±c ti·∫øp t·ª´ kho l∆∞u tr·ªØ ch√≠nh th·ª©c:</p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install portsentry
</code></pre>
<p><strong>Fedora/CentOS/RHEL:</strong> Th√¥ng th∆∞·ªùng b·∫°n s·∫Ω c·∫ßn t·∫£i g√≥i RPM v·ªÅ m√°y. Sau ƒë√≥ s·ª≠ d·ª•ng l·ªánh:</p>
<pre><code class="language-bash">rpm -i portsentry*
</code></pre>
<p>(L∆∞u √Ω: N·∫øu kh√¥ng t√¨m th·∫•y g√≥i RPM, b·∫°n c√≥ th·ªÉ c·∫ßn bi√™n d·ªãch t·ª´ m√£ ngu·ªìn ho·∫∑c t√¨m trong kho EPEL).</p>
<p><strong>Arch Linux:</strong> S·ª≠ d·ª•ng AUR (Arch User Repository). L·ªánh c≈© l√† <code>yaourt</code>, nh∆∞ng hi·ªán nay b·∫°n c√≥ th·ªÉ d√πng <code>yay</code> ho·∫∑c <code>paru</code>:</p>
<pre><code class="language-bash">yaourt -S portsentry
# Ho·∫∑c
yay -S portsentry
</code></pre>
<h3>2. C·∫•u h√¨nh Chi·∫øn thu·∫≠t Gi√°m s√°t</h3>
<p>File c·∫•u h√¨nh ch√≠nh n·∫±m t·∫°i <code>/etc/portsentry/portsentry.conf</code>. Ch√∫ng ta s·∫Ω m·ªü n√≥ l√™n v√† ch·ªânh s·ª≠a:</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.conf
</code></pre>
<h4>A. L·ª±a ch·ªçn b·ªô c·ªïng gi√°m s√°t (Port Configuration)</h4>
<p>PortSentry cung c·∫•p s·∫µn 3 c·∫•p ƒë·ªô gi√°m s√°t. B·∫°n c·∫ßn b·ªè d·∫•u comment (#) ·ªü m·ªôt trong c√°c b·ªô sau t√πy theo m·ª©c ƒë·ªô &quot;nh·∫°y c·∫£m&quot; v·ªÅ b·∫£o m·∫≠t c·ªßa b·∫°n:</p>
<p><strong>C·∫•p ƒë·ªô 1: &quot;Really Anal&quot; (C·ª±c ƒëoan/K·ªπ t√≠nh)</strong>
Ch·ªçn b·ªô n√†y n·∫øu b·∫°n mu·ªën gi√°m s√°t g·∫ßn nh∆∞ t·∫•t c·∫£ c√°c c·ªïng nh·∫°y c·∫£m. B·∫•t k·ª≥ ai ch·∫°m v√†o ƒë·ªÅu s·∫Ω b·ªã x·ª≠ l√Ω. ƒê√¢y l√† l·ª±a ch·ªçn t√¥i khuy√™n d√πng.</p>
<pre><code class="language-bash"># Un-comment these if you are really anal:
TCP_PORTS=&quot;1,7,9,11,15,70,79,80,109,110,111,119,138,139,143,512,513,514,515,540,635,1080,1524,2000,2001,4000,4001,5742,6000,6001,6667,12345,12346,20034,30303,32771,32772,32773,32774,31337,40421,40425,49724,54320&quot;
UDP_PORTS=&quot;1,7,9,66,67,68,69,111,137,138,161,162,474,513,517,518,635,640,641,666,700,2049,32770,32771,32772,32773,32774,31337,54321&quot;
</code></pre>
<p><strong>C·∫•p ƒë·ªô 2: &quot;Aware&quot; (C·∫£nh gi√°c)</strong>
Gi√°m s√°t c√°c c·ªïng ph·ªï bi·∫øn, c√¢n b·∫±ng gi·ªØa b·∫£o m·∫≠t v√† hi·ªáu nƒÉng.</p>
<pre><code class="language-bash"># Use these if you just want to be aware:
# TCP_PORTS=&quot;1,11,15,79,111,119,143,540,635,1080,1524,2000,5742,6667,12345,12346,20034,31337,32771,32772,32773,32774,40421,49724,54320&quot;
# UDP_PORTS=&quot;1,7,9,69,161,162,513,635,640,641,700,32770,32771,32772,32773,32774,31337,54321&quot;
</code></pre>
<p><strong>C·∫•p ƒë·ªô 3: &quot;Bare-bones&quot; (C∆° b·∫£n)</strong>
Ch·ªâ gi√°m s√°t t·ªëi thi·ªÉu. Kh√¥ng khuy·∫øn kh√≠ch d√πng tr·ª´ khi server qu√° y·∫øu.</p>
<h4>B. C·∫•u h√¨nh Stealth Scan (Qu√©t ·∫©n)</h4>
<p>Ngo√†i c√°c c·ªïng tr√™n, b·∫°n c√≥ th·ªÉ c·∫•u h√¨nh gi√°m s√°t d·∫£i c·ªïng cao (tr√™n 1024) ƒë·ªÉ ph√°t hi·ªán c√°c k·ªπ thu·∫≠t qu√©t l√©n l√∫t.</p>
<pre><code class="language-bash">ADVANCED_PORTS_TCP=&quot;1023&quot;
ADVANCED_PORTS_UDP=&quot;1023&quot;
</code></pre>
<p>ƒê·∫∑c bi·ªát, h√£y lo·∫°i tr·ª´ (exclude) c√°c c·ªïng m√† b·∫°n ƒëang th·ª±c s·ª± s·ª≠ d·ª•ng (v√≠ d·ª• c·ªïng Web, DNS, NetBIOS) ƒë·ªÉ tr√°nh ch·∫∑n nh·∫ßm ng∆∞·ªùi d√πng h·ª£p l·ªá:</p>
<pre><code class="language-bash">ADVANCED_EXCLUDE_TCP=&quot;113,139&quot;
ADVANCED_EXCLUDE_UDP=&quot;520,138,137,67&quot;
</code></pre>
<h3>3. C·∫•u h√¨nh Ph·∫£n ·ª©ng v√† Ch·∫∑n (Blocking)</h3>
<p>Khi ph√°t hi·ªán t·∫•n c√¥ng, PortSentry s·∫Ω l√†m g√¨?</p>
<p><strong>K√≠ch ho·∫°t ch·∫ø ƒë·ªô ch·∫∑n</strong>
ƒê·∫£m b·∫£o hai d√≤ng sau ƒë∆∞·ª£c ƒë·∫∑t gi√° tr·ªã 1 (1 = Ch·∫∑n, 0 = Ch·ªâ ghi log, 2 = Ch·∫°y l·ªánh ngo√†i):</p>
<pre><code class="language-bash">BLOCK_UDP=&quot;1&quot;
BLOCK_TCP=&quot;1&quot;
</code></pre>
<p><strong>Ph∆∞∆°ng ph√°p ch·∫∑n: TCP Wrappers</strong>
M·ªôt ph∆∞∆°ng ph√°p ch·∫∑n c·ªï ƒëi·ªÉn nh∆∞ng hi·ªáu qu·∫£ l√† s·ª≠ d·ª•ng <code>hosts.deny</code>. Khi ph√°t hi·ªán IP t·∫•n c√¥ng, PortSentry s·∫Ω ghi IP ƒë√≥ v√†o file <code>/etc/hosts.deny</code>, l√†m cho c√°c d·ªãch v·ª• h·ªó tr·ª£ TCP Wrappers (nh∆∞ SSH c≈©) t·ª´ ch·ªëi k·∫øt n·ªëi ngay l·∫≠p t·ª©c.</p>
<p>T√¨m v√† b·ªè comment d√≤ng n√†y:</p>
<pre><code class="language-bash">KILL_HOSTS_DENY=&quot;ALL: $TARGET$ : DENY&quot;
</code></pre>
<p>(L∆∞u √Ω: <code>$TARGET$</code> l√† bi·∫øn ƒë·∫°i di·ªán cho IP c·ªßa k·∫ª t·∫•n c√¥ng).</p>
<p><strong>File Log v√† L·ªãch s·ª≠</strong>
Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file log ƒë·ªÉ ƒë·∫£m b·∫£o PortSentry ghi d·ªØ li·ªáu ƒë√∫ng ch·ªó (L∆∞u √Ω ƒë∆∞·ªùng d·∫´n c√≥ th·ªÉ kh√°c nhau t√πy distro, v√≠ d·ª• <code>/etc/portsentry/...</code> ho·∫∑c <code>/usr/pkg/etc/...</code>):</p>
<pre><code class="language-bash"># Hosts to ignore (Danh s√°ch tr·∫Øng)
IGNORE_FILE=&quot;/etc/portsentry/portsentry.ignore&quot;
# Hosts that have been denied (L·ªãch s·ª≠ ch·∫∑n)
HISTORY_FILE=&quot;/etc/portsentry/portsentry.history&quot;
# Hosts blocked in this session (Phi√™n hi·ªán t·∫°i)
BLOCKED_FILE=&quot;/etc/portsentry/portsentry.blocked&quot;
</code></pre>
<h3>4. &quot;ƒê√≤n t√¢m l√Ω&quot;: Port Banner</h3>
<p>B·∫°n c√≥ th·ªÉ ƒë·ªÉ l·∫°i m·ªôt l·ªùi nh·∫Øn cho k·∫ª t·∫•n c√¥ng n·∫øu ch√∫ng c·ªë t√¨nh k·∫øt n·ªëi v√†o c√°c c·ªïng b·∫´y. ƒê√¢y l√† m·ªôt t√≠nh nƒÉng th√∫ v·ªã ƒë·ªÉ c·∫£nh b√°o.</p>
<pre><code class="language-bash">PORT_BANNER=&quot;** UNAUTHORIZED ACCESS PROHIBITED *** YOUR CONNECTION ATTEMPT HAS BEEN LOGGED. GO AWAY.&quot;
</code></pre>
<h3>5. B∆∞·ªõc quan tr·ªçng nh·∫•t: Whitelist (Ignore File)</h3>
<p>ƒê·ª´ng t·ª± nh·ªët m√¨nh ·ªü ngo√†i! Tr∆∞·ªõc khi kh·ªüi ƒë·ªông, b·∫°n b·∫Øt bu·ªôc ph·∫£i th√™m IP c·ªßa ch√≠nh m√¨nh v√† IP local v√†o danh s√°ch b·ªè qua.</p>
<p>M·ªü file <code>portsentry.ignore</code> (ƒë∆∞·ªùng d·∫´n ƒë√£ c·∫•u h√¨nh ·ªü b∆∞·ªõc 3):</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.ignore
</code></pre>
<p>Th√™m v√†o:</p>
<pre><code class="language-plaintext">127.0.0.1/32
0.0.0.0
[IP C·ªßa M√°y B·∫°n]
[IP Gateway]
</code></pre>
<h3>6. Kh·ªüi ƒë·ªông v√† Ki·ªÉm tra</h3>
<p>Sau khi ho√†n t·∫•t, kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª•:</p>
<pre><code class="language-bash">sudo service portsentry restart
</code></pre>
<p>ƒê·ªÉ ki·ªÉm tra, h√£y d√πng m·ªôt m√°y kh√°c th·ª±c hi·ªán l·ªánh nmap ƒë∆°n gi·∫£n v√†o server. Sau ƒë√≥ ki·ªÉm tra file <code>/etc/hosts.deny</code> tr√™n server, b·∫°n s·∫Ω th·∫•y IP c·ªßa m√°y t·∫•n c√¥ng ƒë√£ b·ªã th√™m v√†o danh s√°ch ƒëen k√®m theo d√≤ng c·∫£nh b√°o.</p>
<h3>N√¢ng cao: G·ª≠i Email C·∫£nh B√°o Khi Ph√°t Hi·ªán T·∫•n C√¥ng v·ªõi PortSentry</h3>
<p>Vi·ªác nh·∫≠n th√¥ng b√°o ngay l·∫≠p t·ª©c (Real-time Notification) l√† m·ªôt ph·∫ßn c·ªët l√µi c·ªßa DevSecOps v√† gi√°m s√°t an ninh m·∫°ng.</p>
<p>D∆∞·ªõi ƒë√¢y l√† h∆∞·ªõng d·∫´n chi ti·∫øt c√°ch vi·∫øt m·ªôt script Shell ƒë∆°n gi·∫£n ƒë·ªÉ g·ª≠i email v√† t√≠ch h·ª£p n√≥ v√†o <code>KILL_RUN_CMD</code> c·ªßa PortSentry.</p>
<h4>1. Chu·∫©n b·ªã m√¥i tr∆∞·ªùng g·ª≠i mail</h4>
<p>ƒê·ªÉ server Linux g·ª≠i ƒë∆∞·ª£c email, b·∫°n c·∫ßn c√†i ƒë·∫∑t g√≥i <code>mailutils</code> (tr√™n Debian/Ubuntu) ho·∫∑c <code>mailx</code> (tr√™n CentOS).</p>
<p><strong>Ubuntu/Debian:</strong></p>
<pre><code class="language-bash">sudo apt-get update
sudo apt-get install mailutils
</code></pre>
<p>(Trong qu√° tr√¨nh c√†i ƒë·∫∑t, n·∫øu n√≥ h·ªèi c·∫•u h√¨nh Postfix, b·∫°n c√≥ th·ªÉ ch·ªçn &quot;Internet Site&quot; n·∫øu server c√≥ domain, ho·∫∑c &quot;Local only&quot; n·∫øu ch·ªâ test n·ªôi b·ªô. Tuy nhi√™n, ƒë·ªÉ g·ª≠i ra Gmail/Outlook th·ª±c t·∫ø, server c·∫ßn c·∫•u h√¨nh SMTP Relay, nh∆∞ng ta c·ª© ƒëi qua b∆∞·ªõc t·∫°o script tr∆∞·ªõc).</p>
<h4>2. Vi·∫øt Script C·∫£nh B√°o (portsentry_alert.sh)</h4>
<p>Ch√∫ng ta s·∫Ω vi·∫øt m·ªôt script nh·∫≠n tham s·ªë l√† IP k·∫ª t·∫•n c√¥ng v√† C·ªïng b·ªã qu√©t, sau ƒë√≥ so·∫°n n·ªôi dung v√† g·ª≠i mail.</p>
<p>T·∫°o file script:</p>
<pre><code class="language-bash">sudo nano /usr/local/bin/portsentry_alert.sh
</code></pre>
<p>D√°n n·ªôi dung sau v√†o:</p>
<pre><code class="language-bash">#!/bin/bash

# ==========================================
# C·∫§U H√åNH
# ==========================================
TO_EMAIL=&quot;admin@unitrade.id.vn&quot;  # Thay b·∫±ng email c·ªßa b·∫°n
SUBJECT=&quot;[ALERT] PortSentry Detected Attack!&quot;
SERVER_NAME=$(hostname)
DATE=$(date &quot;+%Y-%m-%d %H:%M:%S&quot;)

# Nh·∫≠n tham s·ªë t·ª´ PortSentry
TARGET_IP=$1
TARGET_PORT=$2

# ==========================================
# N·ªòI DUNG EMAIL
# ==========================================
BODY=&quot;
C·∫£nh b√°o b·∫£o m·∫≠t t·ª´ Server: $SERVER_NAME
------------------------------------------------
Th·ªùi gian ph√°t hi·ªán : $DATE
H√†nh ƒë·ªông           : ƒê√£ ch·∫∑n (Blocked)
IP K·∫ª t·∫•n c√¥ng      : $TARGET_IP
C·ªïng b·ªã qu√©t        : $TARGET_PORT
------------------------------------------------
H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông th√™m rule v√†o iptables/hosts.deny.
Vui l√≤ng ki·ªÉm tra log t·∫°i /var/log/syslog ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.
&quot;

# ==========================================
# G·ª¨I MAIL
# ==========================================
echo &quot;$BODY&quot; | mail -s &quot;$SUBJECT&quot; &quot;$TO_EMAIL&quot;
</code></pre>
<p>C·∫•p quy·ªÅn th·ª±c thi cho script:</p>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/portsentry_alert.sh
</code></pre>
<h4>3. T√≠ch h·ª£p Script v√†o PortSentry</h4>
<p>B√¢y gi·ªù ch√∫ng ta quay l·∫°i file c·∫•u h√¨nh c·ªßa PortSentry ƒë·ªÉ &quot;d·∫°y&quot; n√≥ c√°ch g·ªçi script n√†y khi ph√°t hi·ªán t·∫•n c√¥ng.</p>
<p>M·ªü file config:</p>
<pre><code class="language-bash">sudo nano /etc/portsentry/portsentry.conf
</code></pre>
<p>T√¨m d√≤ng <code>KILL_RUN_CMD</code>. D√≤ng n√†y cho ph√©p ch·∫°y m·ªôt l·ªánh ngo√†i (external command) tr∆∞·ªõc khi ch·∫∑n IP. S·ª≠a l·∫°i nh∆∞ sau:</p>
<pre><code class="language-bash"># $TARGET$ l√† bi·∫øn ch·ª©a IP, $PORT$ l√† bi·∫øn ch·ª©a c·ªïng
KILL_RUN_CMD=&quot;/usr/local/bin/portsentry_alert.sh $TARGET$ $PORT$&quot;
</code></pre>
<p>L∆∞u √Ω quan tr·ªçng: ƒê·∫£m b·∫£o bi·∫øn <code>BLOCK_UDP</code> v√† <code>BLOCK_TCP</code> ·ªü ch·∫ø ƒë·ªô 1 (Block) ho·∫∑c 2 (Run Command Only) th√¨ l·ªánh tr√™n m·ªõi ƒë∆∞·ª£c th·ª±c thi. T·ªët nh·∫•t l√† ƒë·ªÉ 1 ƒë·ªÉ v·ª´a ch·∫∑n v·ª´a g·ª≠i mail.</p>
<h4>4. Kh·ªüi ƒë·ªông l·∫°i v√† Test</h4>
<p>Restart PortSentry:</p>
<pre><code class="language-bash">sudo service portsentry restart
</code></pre>
<p>Th·ª≠ nghi·ªám (Attack Simulation): S·ª≠ d·ª•ng m√°y kh√°c (ho·∫∑c ƒëi·ªán tho·∫°i d√πng 4G - ƒë·ªÉ kh√°c IP m·∫°ng Lan) qu√©t th·ª≠:</p>
<pre><code class="language-bash">nmap -p 1-100 &lt;IP_Server_Cua_Ban&gt;
</code></pre>
<p>N·∫øu th√†nh c√¥ng, b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt email v·ªõi n·ªôi dung:
<code>Subject: [ALERT] PortSentry Detected Attack! Body: C·∫£nh b√°o b·∫£o m·∫≠t... IP K·∫ª t·∫•n c√¥ng: 1.2.3.4.</code></p>

        </div>
    </article>

    <div style="margin-top: 40px;">
        <a href="/dulkanggg/">&larr; Back to Home</a>
    </div>

    <footer>
    <p>&copy; 2025 Khang. All rights reserved.</p>
    <div class="social-links">
        <a href="https://github.com/khanchannn" target="_blank">GitHub</a>
        <a href="https://www.facebook.com/dulkanggg1504/" target="_blank">Facebook</a>
        <a href="mailto:dulkanggg1504@gmail.com">Email</a>
    </div>
</footer>
</div> <!-- End container -->
</body>

</html>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const codeBlocks = document.querySelectorAll('.post-content pre');

                codeBlocks.forEach(pre => {
                    const button = document.createElement('button');
                    button.className = 'copy-btn';
                    button.textContent = 'Copy';

                    button.addEventListener('click', () => {
                        const code = pre.querySelector('code').innerText;
                        navigator.clipboard.writeText(code).then(() => {
                            button.textContent = 'Copied!';
                            setTimeout(() => {
                                button.textContent = 'Copy';
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy:', err);
                            button.textContent = 'Error';
                        });
                    });

                    pre.appendChild(button);
                });
            });
        </script>